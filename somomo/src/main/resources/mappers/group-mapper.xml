<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="groupMapper">
  <resultMap id="groupResultSet" type="groupRoom">
		<result column="GROUP_NO" property="groupNo"/>
		<result column="REGION_NO" property="regionNo"/>
		<result column="REGION_NAME" property="regionName"/>
		<result column="CATEGORY_NO" property="categoryNo"/>
		<result column="CATEGORY_NAME" property="categoryName"/>
		<result column="GROUP_NAME" property="groupName"/>
		<result column="GROUP_IMG" property="groupImg"/>
		<result column="GROUP_DETAIL" property="groupDetail"/>
		<result column="GROUP_TYPE" property="groupType"/>
		<result column="GROUP_TYPE_STR" property="groupTypeStr"/>
		<result column="GROUP_DATE" property="groupDate"/>
		<result column="MEMBER_COUNT" property="memberCount"/>
		<result column="MY_GROUP" property="myGroup"/>
		<result column="APPLYING" property="applying" />
		<result column="USER_RANK" property="userRank"/>
	</resultMap>
	
	<resultMap id="memberResultSet" type="groupMember">
		<result column="GROUP_NO" property="groupNo"/>
		<result column="USER_ID" property="userId"/>
		<result column="USER_RANK" property="userRank"/>
		<result column="NICKNAME" property="nickname"/>
		<result column="PROFILE_IMG" property="profileImg"/> 
	</resultMap>
	
	<resultMap id="groupCategoryResultSet" type="groupCategory">
		<result column="CATEGORY_NO" property="categoryNo" />
		<result column="CATEGORY_NAME" property="categoryName" />
	</resultMap>
	
	<resultMap id="regionCategoryResultSet" type="regionCategory">
		<result column="REGION_NO" property="regionNo" />
		<result column="REGION_NAME" property="regionName" />
	</resultMap>
	
	<resultMap id="applicationListSet" type="groupJoinApply">
		<result column="APPLY_NO" property="applyNo" />
		<result column="GROUP_NO" property="groupNo" />
		<result column="USER_ID" property="userId" />
		<result column="GREETING" property="greeting" />
		<result column="APPLY_DATE" property="applyDate"/>
		<result column="NICKNAME" property="nickname"/>
		<result column="STATUS" property="status"/>
	</resultMap>
	
	<resultMap id="groupCalendarResultSet" type="GroupCalendar">
		<result column="CALENDAR_NO" property="calendarNo" />
		<result column="GROUP_NO" property="groupNo" />
	</resultMap>
	
	<resultMap id="groupCalendarEventResultSet" type="CalendarPlan">
		<result column="PLAN_NO" property="planNo" />
		<result column="CALENDAR_NO" property="calendarNo" />
		<result column="USER_ID" property="userId" />
		<result column="TITLE" property="title" />
		<result column="MEMO" property="memo" />
		<result column="START_DATE" property="startDate" />
		<result column="START_TIME" property="startTime" />
		<result column="END_DATE" property="endDate" />
		<result column="END_TIME" property="endTime" />
		<result column="COLOR" property="color" />
		<result column="TEXT_COLOR" property="textColor" />
		<result column="ALLDAY" property="allDay" />
		
	</resultMap>
	
	<select id="selectGroupListCount" resultType="_int" parameterType="string">
		SELECT 
		       COUNT(*) 
		  FROM 
		       GROUP_ROOM
		 <if test="categoryNo != 0">
		 WHERE 
		       CATEGORY_NO = #{categoryNo}		 
		 </if>
	</select>
	
	<select id="selectRegionCategoryList" resultMap="regionCategoryResultSet">
		SELECT 
			   REGION_NO,
			   REGION_NAME
		  FROM 
		       REGION_CATEGORY
	</select>
	
	
	<select id="selectGroupCategoryList" resultMap="groupCategoryResultSet">
		SELECT 
			   CATEGORY_NO,
			   CATEGORY_NAME
		  FROM 
		       GROUP_CATEGORY
	</select>
	
	<select id="selectGroupList" resultMap="groupResultSet" parameterType="hashMap">
		SELECT
       		   GROUP_NO,
       		   GROUP_NAME,
       		   REGION_NAME,
       		   CATEGORY_NAME,
       		   GROUP_IMG,
       		   GROUP_NAME,
       		   GROUP_DETAIL,
       		   GROUP_TYPE,
       		   DECODE(GROUP_TYPE, 'A', '공개', 'B', '그룹명 공개', 'C', '비공개') AS GROUP_TYPE_STR,
       		   GROUP_DATE,
       		   MY_GROUP,
       		   APPLYING,
       		   MEMBER_COUNT
  		  FROM
       		   GROUP_ROOM R
  		  JOIN
       		   REGION_CATEGORY USING(REGION_NO)
  		  JOIN
       		   GROUP_CATEGORY USING(CATEGORY_NO)
  		  LEFT
  		  JOIN
       		   (SELECT 
       		           GROUP_NO, 
       		           'Y' AS MY_GROUP
          		  FROM 
          		       GROUP_MEMBER
         		 WHERE 
         		       USER_ID = #{userId}) USING(GROUP_NO)
          LEFT
          JOIN
               (SELECT 
                       GROUP_NO,
                       'A' AS APPLYING
                  FROM
                       GROUP_JOIN_APPLY
                 WHERE
                       USER_ID = #{userId}) USING(GROUP_NO)
  		  LEFT
  		  JOIN
       		   (SELECT 
       		   		   GROUP_NO,
       		           COUNT(*) AS MEMBER_COUNT
          		  FROM 
          	 	       GROUP_MEMBER
         		 GROUP
              		BY 
              		   GROUP_NO) USING(GROUP_NO)
       <if test="categoryNo != 0">
         WHERE CATEGORY_NO = #{categoryNo}
       </if>
         ORDER 
            BY 
               GROUP_NO DESC
	</select>
	
	<select id="myGroupList" parameterType="string" resultMap="groupResultSet">
		SELECT 
			   GROUP_NO, 
			   GROUP_IMG, 
			   GROUP_NAME, 
			   USER_RANK
  		  FROM 
  		       GROUP_ROOM
  		  JOIN 
  		       GROUP_MEMBER USING(GROUP_NO)
 		 WHERE 
 		       USER_ID = #{userId}
 		 GROUP 
 		    BY 
 		       GROUP_NO, 
 		       GROUP_IMG, 
 		       GROUP_NAME, 
 		       USER_RANK
 		 ORDER 
    	    BY 
    	       GROUP_NO DESC
	</select>
	
	<insert id="insertGroup" parameterType="groupRoom">
		INSERT 
			INTO GROUP_ROOM
				(
				GROUP_NO,
				REGION_NO,
				CATEGORY_NO,
				GROUP_NAME,
				GROUP_IMG,
				GROUP_DETAIL,
				GROUP_TYPE,
				GROUP_DATE
				)
			VALUES
				(
				SEQ_GNO.NEXTVAL,
				#{regionNo},
				#{categoryNo},
				#{groupName},
				#{groupImg},
				#{groupDetail},
				#{groupType},
				SYSDATE
				)
	
	</insert>
	
	<insert id="insertRoomAdmin" parameterType="groupMember">
		INSERT 
			INTO GROUP_MEMBER
				(
				GROUP_NO,
				USER_ID,
				USER_RANK
				)
			VALUES
				(
				SEQ_GNO.CURRVAL,
				#{userId},
				#{userRank}
				)
	</insert>
	
	<insert id="insertCalendar">
		INSERT
		  INTO
		       GROUP_CALENDAR
		VALUES
			   (
			   SEQ_GCDNO.NEXTVAL,
			   SEQ_GNO.CURRVAL
			   )		 
	</insert>

	<select id="getGroupNo" resultType="int">
		SELECT 
		       LAST_NUMBER - 1
	      FROM 
	           USER_SEQUENCES
	     WHERE 
	           SEQUENCE_NAME = 'SEQ_GNO'
	</select>
	
	<select id="selectGroup" parameterType="_int" resultMap="groupResultSet">
		SELECT 
		       R.GROUP_NO, 
		       REGION_NO, 
		       CATEGORY_NO, 
		       GROUP_NAME, 
		       GROUP_DETAIL, 
		       GROUP_IMG, 
		       DECODE(GROUP_TYPE, 'A', '공개', 'B', '그룹명 공개', 'C', '비공개')GROUP_TYPE, 
		       GROUP_DATE, 
		       COUNT(M.GROUP_NO) MEMBER_COUNT
  		  FROM 
  		       GROUP_ROOM R
  	      LEFT 
  	      JOIN 
  	           GROUP_MEMBER M ON(R.GROUP_NO = M.GROUP_NO)
 		 WHERE 
 		       R.GROUP_NO = #{groupNo}
 		 GROUP 
 		    BY 
 		       R.GROUP_NO, 
 		       REGION_NO, 
 		       CATEGORY_NO, 
 		       GROUP_NAME, 
 		       GROUP_DETAIL, 
 		       GROUP_IMG,
 		       GROUP_TYPE, 
 		       GROUP_DATE
	</select>

	<select id="selectMemberList" parameterType="_int" resultMap="memberResultSet">
		SELECT 
			   USER_ID, 
			   NICKNAME, 
			   DECODE(USER_RANK, 'A', '관리자', '일반회원') AS "USER_RANK",
			   PROFILE_IMG
  		  FROM 
  		  	   GROUP_MEMBER
  	 	  JOIN 
  	 	  	   MEMBER USING(USER_ID)
 		 WHERE 
 		 	   GROUP_NO = #{groupNo}
 	     ORDER 
 	        BY 
 	           USER_RANK ASC
	</select>
	
	<update id="updateGroup" parameterType="groupRoom">
		UPDATE 
       		   GROUP_ROOM
   	 	   SET 
       		   REGION_NO = #{regionNo},
       		   CATEGORY_NO = #{categoryNo},
       		   GROUP_NAME = #{groupName},
       		   GROUP_DETAIL = #{groupDetail},
       		   GROUP_IMG = #{groupImg}
 		 WHERE
       		   GROUP_NO = #{groupNo}
	</update>
	
	<update id="updateType" parameterType="groupRoom">
		UPDATE
		       GROUP_ROOM
		   SET
		       GROUP_TYPE = #{groupType}
		 WHERE 
		       GROUP_NO = #{groupNo}
	</update>
	
	<delete id="deleteGroup" parameterType="_int">
		DELETE
		       GROUP_ROOM
		 WHERE
		       GROUP_NO = ${groupNo}
	</delete>
	
	<insert id="applyGroup" parameterType="groupJoinApply">
		INSERT 
		       INTO GROUP_JOIN_APPLY
		       (
		       APPLY_NO,
		       GROUP_NO,
		       USER_ID,
		       GREETING
		       )
		VALUES
			   (
			   SEQ_GJANO.NEXTVAL,
			   #{groupNo},
			   #{userId},
			   #{greeting}
			   )  
	</insert>
	
	<select id="getApplicationList" parameterType="_int" resultMap="applicationListSet">
		SELECT 
			   APPLY_NO,
			   USER_ID, 
			   NICKNAME, 
			   GREETING
  		  FROM 
  		  	   GROUP_JOIN_APPLY
  		  JOIN 
  		  	   MEMBER USING(USER_ID)
 	     WHERE 
 	           GROUP_NO = #{groupNo}
	</select>
	
	<insert id="insertRoomMember" parameterType="groupMember">
		INSERT 
		  INTO 
		       GROUP_MEMBER
		       (
		       GROUP_NO,
		       USER_ID
		       )
		VALUES
		       (
		       #{groupNo},
		       #{userId}
		       )
	</insert>
	
	<select id="countApplication" parameterType="_int" resultType="_int">
		SELECT
		       COUNT(*)
		  FROM
		       GROUP_JOIN_APPLY
		 WHERE
		       GROUP_NO = #{groupNo}     
		     
	</select>
	
	<delete id="delteApplyInfo" parameterType="groupJoinApply">
		DELETE
		       GROUP_JOIN_APPLY
		 WHERE
		       GROUP_NO = #{groupNo}
		   AND
		       USER_ID = #{userId}
	</delete>
	
	
	<select id="selectGroupCalendar" parameterType="_int" resultMap="groupCalendarResultSet">
		SELECT 
			   CALENDAR_NO,
			   GROUP_NO
		  FROM 
		       GROUP_CALENDAR
		  WHERE 
		       GROUP_NO = #{groupNo}
	</select>
	
	
	<insert id="insertCalendarEvent" parameterType="CalendarPlan">
		INSERT 
			INTO CALENDAR_PLAN
				(
				PLAN_NO,
				CALENDAR_NO,
				USERID,
				TITLE,
				MEMO,
				START_DATE,
				START_TIME, 
				END_DATE,
				END_TIME, 
				COLOR,
				TEXT_COLOR,
				ALLDAY
				)
			VALUES
				(

				SEQ_PNO.NEXTVAL,
				#{calendarNo},
				#{userId},
				#{title},
				#{memo},
				#{startDate},
				#{startTime},
				#{endDate},
				#{endTime},
				#{color},
				#{textColor},
				#{allDay}
				)
	</insert>
	
	
	
	<select id="selectCalendarEventList" resultMap="groupCalendarEventResultSet">
		SELECT 
		       	USERID,
				TITLE,
				MEMO,
				START_DATE,
				START_TIME, 
				END_DATE,
				END_TIME, 
				COLOR,
				TEXT_COLOR,
				ALLDAY
		  FROM 
		       CALENDAR_PLAN
		  WHERE
		  	   CALENDAR_NO = #{calendarNo}
	</select>
	
	
	
</mapper>
